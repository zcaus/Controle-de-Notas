<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Produ√ß√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5; /* Cinza muito claro, quase branco */
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff; /* Branco puro */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); /* Sombra mais suave */
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a6d8a 0%, #607d8b 100%); /* Azul acinzentado */
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2); /* Sombra de texto mais sutil */
        }
        
        .profile-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .profile-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            position: relative;
        }
        
        .profile-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .profile-btn.active {
            background: #ffffff; /* Branco */
            color: #4a6d8a; /* Cor principal do header */
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef5350; /* Vermelho suave */
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 0.7em;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            background: #f8f8f8; /* Cinza bem claro */
            border: 2px dashed #e0e0e0; /* Cinza de borda */
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #78909c; /* Azul acinzentado do bot√£o padr√£o */
            background: #f5f5f5;
        }
        
        .upload-btn {
            background: #4caf50; /* Verde mais suave */
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #4a6d8a 0%, #607d8b 100%); /* Mesmo gradiente do header */
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative; /* Necess√°rio para o posicionamento do tooltip */
        }
        
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        /* Estilo para o Tooltip de NFs */
        /* Estilo para o Tooltip de NFs */
        .nf-tooltip {
            visibility: hidden; /* Come√ßa escondido */
            width: 250px; /* Largura do tooltip */
            background-color: rgba(0, 0, 0, 0.85); /* Fundo escuro semi-transparente */
            color: #fff; /* Texto branco */
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute; /* Posi√ß√£o absoluta em rela√ß√£o ao pai (stat-card) */
            z-index: 1; /* Acima de outros elementos */
            /* bottom: 125%; */ /* Removido para abrir para baixo */
            top: 125%; /* Posi√ß√£o ABAIXO do card (ajustado aqui) */
            left: 50%;
            margin-left: -125px; /* Centralizar o tooltip */
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            max-height: 200px; /* Altura m√°xima para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se o conte√∫do for muito longo */
            font-size: 0.9em;
        }

        .nf-tooltip::after {
            content: "";
            position: absolute;
            /* top: 100%; */ /* Removido para abrir para baixo */
            bottom: 100%; /* Posi√ß√£o da "seta" - ajustado para o topo do tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(0, 0, 0, 0.85) transparent; /* Cor da seta - ajustado */
        }

        /* Mostrar o tooltip no hover */
        .stat-card:hover .nf-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-input {
            padding: 10px;
            border: 1px solid #e0e0e0; /* Cinza de borda */
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); /* Sombra mais suave */
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0; /* Linhas divis√≥rias suaves */
        }
        
        th {
            background: #607d8b; /* Azul acinzentado do header */
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody tr:hover {
            background: #f8f8f8; /* Cinza claro no hover */
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        /* Cores de status mais neutras/suaves */
        .status-embalagem {
            background: #fff8e1; /* Amarelo muito claro */
            color: #ffa000; /* Laranja */
        }
        
        .status-expedicao { 
            background: #e3f2fd; /* Azul muito claro */
            color: #2196f3; /* Azul */
        }
        
        .status-parcial {
            background: #ffe0b2; /* Laranja muito claro */
            color: #ef6c00; /* Laranja escuro */
        }
        
        .status-concluido {
            background: #e8f5e9; /* Verde muito claro */
            color: #43a047; /* Verde */
        }

        .status-aguardandoConfirmacao {
            background: #fce4ec; /* Rosa muito claro */
            color: #ad1457; /* P√∫rpura/vermelho vinho */
        }
        
        .action-btn {
            background: #78909c; /* Azul acinzentado padr√£o */
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            margin: 2px;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(120, 144, 156, 0.4); /* Sombra com a cor do bot√£o */
        }
        
        .action-btn.danger {
            background: #ef5350; /* Vermelho suave */
        }
        
        .action-btn.success {
            background: #4caf50; /* Verde */
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4); /* Sombra mais leve */
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); /* Sombra mais suave */
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .alert-success {
            background: #e8f5e9; /* Verde muito claro */
            color: #43a047; /* Verde */
            border: 1px solid #c8e6c9;
        }
        
        .alert-danger {
            background: #ffebee; /* Vermelho muito claro */
            color: #ef5350; /* Vermelho */
            border: 1px solid #ffccbc;
        }
        
        .alert-info {
            background: #e0f2f7; /* Azul claro */
            color: #26c6da; /* Ciano */
            border: 1px solid #b2ebf2;
        }

        .select-all-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8; /* Fundo cinza claro */
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .select-all-container label {
            font-weight: bold;
            color: #555;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .profile-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Controle de Produ√ß√£o</h1>
            <div class="profile-selector">
                <button class="profile-btn active" id="btn-admin" onclick="changeProfile('admin')">Administrador</button>
                <button class="profile-btn" id="btn-embalagem" onclick="changeProfile('embalagem')">Embalagem</button>
                <button class="profile-btn" id="btn-expedicao" onclick="changeProfile('expedicao')">Expedi√ß√£o</button>
            </div>
        </div>
        
        <div class="content">
            <div id="upload-section" class="upload-section hidden"> 
                <h3>üìÅ Upload da Planilha Excel (Desativado: Lendo do Google Sheets)</h3>
                <p>O sistema agora l√™ e grava diretamente no Google Sheets. Esta se√ß√£o est√° desativada.</p>
                </div>
            
            <div id="alert-container"></div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 id="total-system-items">0</h3>
                    <p>Total no Sistema</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-table-items">0</h3>
                    <p>Itens na Tabela</p>
                </div>
                <div class="stat-card" id="nf-unique-card">
                    <h3 id="total-unique-nfs">0</h3>
                    <p>Total de NFs √önicas</p>
                    <div id="nf-tooltip" class="nf-tooltip"></div>
                </div>
                <div class="stat-card">
                    <h3 id="embalagem-items">0</h3>
                    <p>Na Embalagem</p>
                </div>
                <div class="stat-card">
                    <h3 id="expedicao-items">0</h3>
                    <p>Na Expedi√ß√£o</p>
                </div>
                <div class="stat-card">
                    <h3 id="concluido-items">0</h3>
                    <p>Conclu√≠dos</p>
                </div>
            </div>
            
            <div class="filters">
                <input type="text" class="filter-input" id="filter-nf" placeholder="Filtrar por NF">
                <input type="text" class="filter-input" id="filter-pedido" placeholder="Filtrar por Pedido">
                <input type="text" class="filter-input" id="filter-produto" placeholder="Filtrar por Produto">
                <select class="filter-input" id="filter-status">
                    <option value="">Todos os Status</option>
                    <option value="embalagem">Na Embalagem</option>
                    <option value="expedicao">Na Expedi√ß√£o</option>
                    <option value="parcial">Parcial</option>
                    <option value="aguardandoConfirmacao">Aguardando Confirma√ß√£o</option>
                    <option value="concluido">Conclu√≠do</option>
                </select>
                <select class="filter-input hidden" id="filter-expedicao-view">
                    <option value="todos">Mostrar Todos</option>
                    <option value="pendentes">Mostrar Pendentes</option>
                    <option value="concluidos">Mostrar Conclu√≠dos</option>
                </select>
            </div>

            <div id="select-all-actions" class="select-all-container hidden">
                <input type="checkbox" id="select-all-expedicao" onchange="toggleSelectAll()">
                <label for="select-all-expedicao">Selecionar Todos</label>
                <button class="action-btn success" onclick="confirmSelectedItems()">Confirmar Selecionados</button>
            </div>
            
            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th id="checkbox-header" class="hidden"></th>
                            <th>NF</th>
                            <th>Pedido do Cliente</th>
                            <th>Data Emiss√£o</th>
                            <th>Modelo</th>
                            <th>Produto</th>
                            <th>Qtd Original</th>
                            <th>Separado</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Item</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="edit-form">
                <div class="form-group">
                    <label>Quantidade Separada:</label>
                    <input type="number" id="edit-separado" min="0" required>
                </div>
                <div class="form-group">
                    <label>Quantidade Original:</label>
                    <input type="number" id="edit-original" readonly>
                </div>
                <button type="submit" class="action-btn success">Salvar</button>
                <button type="button" class="action-btn" onclick="closeModal()">Cancelar</button>
            </form>
        </div>
    </div>
    
    <script>
        // COLOQUE A URL DO SEU WEB APP DO APPS SCRIPT AQUI!
        // Ser√° algo como: https://script.google.com/macros/s/SEU_ID_DE_DEPLOYMENT/exec
        const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzWY3TcFvWXk4kVsak8S5gJDRdH3xNfjXfTCj_ClYOvQ5ZHbbW3NoTYNxyWOL4aLZt8Jw/exec'; // <--- ATUALIZE ESTA URL!

        let currentProfile = 'admin';
        let data = [];
        console.log('1. Script carregado. Vari√°vel data inicial:', data);
        let filteredData = [];
        let currentEditItem = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupFilters();
            loadDataFromGoogleSheet();
            document.getElementById('btn-admin').classList.add('active');

            // Adicionar listeners para o card de NFs √önicas (para o tooltip)
            const nfUniqueCard = document.getElementById('nf-unique-card');
            const nfTooltip = document.getElementById('nf-tooltip');

            if (nfUniqueCard && nfTooltip) {
                nfUniqueCard.addEventListener('mouseenter', () => {
                    const uniqueNFs = new Set();
                    data.forEach(item => {
                        uniqueNFs.add(item.nf);
                    });
                    let nfList = Array.from(uniqueNFs).sort((a, b) => {
                        const numA = Number(a);
                        const numB = Number(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return String(a).localeCompare(String(b));
                    }).join('<br>');

                    if (nfList === '') {
                        nfList = 'Nenhuma NF encontrada.';
                    }
                    nfTooltip.innerHTML = `<strong>NFs √önicas:</strong><br>${nfList}`;
                    nfTooltip.style.visibility = 'visible';
                    nfTooltip.style.opacity = '1';
                });

                nfUniqueCard.addEventListener('mouseleave', () => {
                    nfTooltip.style.visibility = 'hidden';
                    nfTooltip.style.opacity = '0';
                });
            }
        });
        
        function changeProfile(profile) {
            console.log('changeProfile: Alterando para o perfil:', profile);
            currentProfile = profile;
            
            document.querySelectorAll('.profile-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${profile}`).classList.add('active');
            
            const uploadSection = document.getElementById('upload-section');
            uploadSection.style.display = 'none';

            const selectAllActions = document.getElementById('select-all-actions');
            const checkboxHeader = document.getElementById('checkbox-header');
            const filterExpedicaoView = document.getElementById('filter-expedicao-view');

            if (profile === 'expedicao') {
                selectAllActions.classList.remove('hidden');
                checkboxHeader.classList.remove('hidden');
                filterExpedicaoView.classList.remove('hidden');
                document.getElementById('filter-status').value = ''; 
            } else {
                selectAllActions.classList.add('hidden');
                checkboxHeader.classList.add('hidden');
                document.getElementById('select-all-expedicao').checked = false;
                filterExpedicaoView.classList.add('hidden');
                filterExpedicaoView.value = 'todos';
            }
            
            updateDisplay();
        }

        async function loadDataFromGoogleSheet() {
            console.log('2. loadDataFromGoogleSheet() foi chamada. Iniciando requisi√ß√£o GET...');
            showAlert('Carregando dados da planilha online...', 'info');
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na rede ou no servidor Apps Script: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();

                if (result.error) {
                    throw new Error(`Erro do Apps Script: ${result.error} - ${result.details || ''}`);
                }

                data = result;
                console.log('3. loadDataFromGoogleSheet: Dados recarregados na vari√°vel "data". Total de itens:', data.length);
                
                data.forEach((item, i) => {
                    console.log(`Item ${i}: NF=${item.nf}, Qtd=${item.qtdOriginal}, Sep=${item.separado}, currentStage=${item.currentStage}, statusExpedicao=${item.statusExpedicao}, statusFinal=${item.status}`);
                });

                showAlert('Dados carregados com sucesso da planilha online!', 'success');
                updateDisplay();

            } catch (error) {
                showAlert(`Erro ao carregar dados da planilha: ${error.message}`, 'danger');
                console.error('Erro ao carregar dados do Google Sheet:', error);
            }
        }

        async function updateItemInGoogleSheet(itemOrItemsToUpdate) {
            console.log('4. updateItemInGoogleSheet() foi chamada para salvar. Dados a enviar:', itemOrItemsToUpdate);
            showAlert('Salvando altera√ß√µes na planilha online...', 'info');
            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemOrItemsToUpdate)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na rede ou no servidor Apps Script ao salvar: ${response.status} ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();

                if (result.error) {
                    throw new Error(`Erro do Apps Script ao salvar: ${result.error} - ${result.details || ''}`);
                }

                showAlert(result.message || 'Dados salvos com sucesso na planilha online!', 'success');
                console.log('5. updateItemInGoogleSheet: Salvamento bem-sucedido. Recarregando dados...');
                await loadDataFromGoogleSheet();

            } catch (error) {
                showAlert(`Erro ao salvar dados na planilha: ${error.message}`, 'danger');
                console.error('Erro ao salvar dados no Google Sheet:', error);
            }
        }

        function getStatus(qtdOriginal, separado, currentStage, statusExpedicao) {
            if (currentStage === 'concluido' && statusExpedicao === 'confirmado') return 'concluido';
            if (currentStage === 'expedicao' && statusExpedicao === 'aguardandoConfirmacao') return 'aguardandoConfirmacao';
            if (separado > 0 && separado < qtdOriginal) return 'parcial';
            if (separado === 0) return 'embalagem';
            if (separado === qtdOriginal && currentStage === 'expedicao') return 'expedicao'; 
            return 'embalagem';
        }
        
        function updateDisplay() {
            console.log('6. updateDisplay() foi chamada. Aplicando filtros e renderizando tabela...');
            filterData();
            renderTable();
            updateStats();
            updateNotificationBadges();
            console.log('6.1. Display atualizado. Itens filtrados para exibi√ß√£o:', filteredData.length);
        }
        
        function filterData() {
            console.log('7. filterData() - Perfil atual:', currentProfile);
            let filtered = [...data];

            if (currentProfile === 'embalagem') {
                filtered = filtered.filter(item => 
                    (item.currentStage === 'embalagem')
                );
            } else if (currentProfile === 'expedicao') {
                const expedicaoViewFilter = document.getElementById('filter-expedicao-view').value;

                filtered = filtered.filter(item =>
                    (item.currentStage === 'expedicao' && item.statusExpedicao === 'aguardandoConfirmacao') ||
                    (item.currentStage === 'embalagem' && item.statusExpedicao === 'parcialmenteSeparado') ||
                    (item.currentStage === 'concluido' && item.statusExpedicao === 'confirmado')
                );

                if (expedicaoViewFilter === 'pendentes') {
                    filtered = filtered.filter(item => 
                        item.currentStage !== 'concluido' || item.statusExpedicao !== 'confirmado'
                    );
                } else if (expedicaoViewFilter === 'concluidos') {
                    filtered = filtered.filter(item => 
                        item.currentStage === 'concluido' && item.statusExpedicao === 'confirmado'
                    );
                }

            } else if (currentProfile === 'admin') {
                // Admin v√™ todos os itens
            }
            
            const nfFilter = document.getElementById('filter-nf').value.toLowerCase();
            const pedidoFilter = document.getElementById('filter-pedido').value.toLowerCase();
            const produtoFilter = document.getElementById('filter-produto').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            
            if (nfFilter) {
                filtered = filtered.filter(item => 
                    String(item.nf).toLowerCase().includes(nfFilter)
                );
            }
            
            if (pedidoFilter) {
                filtered = filtered.filter(item => 
                    String(item.pedido).toLowerCase().includes(pedidoFilter)
                );
            }
            
            if (produtoFilter) {
                filtered = filtered.filter(item => 
                    String(item.produto).toLowerCase().includes(produtoFilter)
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(item => {
                    return item.status === statusFilter; 
                });
            }
            
            filteredData = filtered;
            console.log('7.1. filterData() - Itens ap√≥s filtragem:', filteredData.length);
            updateSelectAllCheckbox();
        }

        function updateStats() {
            const totalSystemItems = data.length;
            const totalTableItems = filteredData.length;

            const uniqueNFs = new Set();
            data.forEach(item => {
                uniqueNFs.add(item.nf);
            });
            const totalUniqueNFs = uniqueNFs.size;

            const embalagemItems = data.filter(item => item.currentStage === 'embalagem').length;
            const expedicaoItems = data.filter(item => item.currentStage === 'expedicao' && item.statusExpedicao === 'aguardandoConfirmacao').length;
            const concluidoItems = data.filter(item => item.currentStage === 'concluido' && item.statusExpedicao === 'confirmado').length;

            document.getElementById('total-system-items').textContent = totalSystemItems;
            document.getElementById('total-table-items').textContent = totalTableItems;
            document.getElementById('total-unique-nfs').textContent = totalUniqueNFs;
            document.getElementById('embalagem-items').textContent = embalagemItems;
            document.getElementById('expedicao-items').textContent = expedicaoItems;
            document.getElementById('concluido-items').textContent = concluidoItems;
            console.log('8. updateStats: Total Sistema:', totalSystemItems, 'Itens Tabela:', totalTableItems, 'NFs √önicas:', totalUniqueNFs, 'Embalagem:', embalagemItems, 'Expedi√ß√£o:', expedicaoItems, 'Conclu√≠dos:', concluidoItems);
        }

        function updateNotificationBadges() {
            const embalagemCount = data.filter(item => item.currentStage === 'embalagem').length;
            const expedicaoCount = data.filter(item => item.currentStage === 'expedicao' && item.statusExpedicao === 'aguardandoConfirmacao').length;

            const btnEmbalagem = document.getElementById('btn-embalagem');
            const btnExpedicao = document.getElementById('btn-expedicao');

            updateBadge(btnEmbalagem, embalagemCount);
            updateBadge(btnExpedicao, expedicaoCount);
            console.log('9. updateNotificationBadges: Embalagem:', embalagemCount, 'Expedi√ß√£o:', expedicaoCount);
        }

        function updateBadge(buttonElement, count) {
            let badge = buttonElement.querySelector('.notification-badge');
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    buttonElement.appendChild(badge);
                }
                badge.textContent = count;
            } else {
                if (badge) {
                    badge.remove();
                }
            }
        }

        async function confirmDelivery(itemId) {
            console.log('confirmDelivery() chamado para item ID:', itemId);
            const itemToConfirm = data.find(item => item.id === itemId);
            if (itemToConfirm) {
                const updatedItemData = {
                    id: itemToConfirm.id,
                    _rowIndex: itemToConfirm._rowIndex,
                    separado: itemToConfirm.qtdOriginal,
                    currentStage: 'concluido',
                    statusExpedicao: 'confirmado',
                };
                await updateItemInGoogleSheet(updatedItemData);
                console.log('confirmDelivery: Requisi√ß√£o de atualiza√ß√£o enviada para:', updatedItemData);
            } else {
                console.error('Item n√£o encontrado para confirmar entrega:', itemId);
            }
        }

        function selectItem(itemId, isChecked) {
            const item = data.find(item => item.id === itemId);
            if (item) {
                item.selected = isChecked;
                console.log(`Item ID ${itemId} selecionado: ${isChecked}`);
                updateSelectAllCheckbox();
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-expedicao');
            const isChecked = selectAllCheckbox.checked;
            console.log('toggleSelectAll: Checagem geral:', isChecked);

            filteredData.forEach(item => {
                if (item.currentStage === 'expedicao' && item.statusExpedicao === 'aguardandoConfirmacao' && item.separado === item.qtdOriginal) {
                    item.selected = isChecked;
                }
            });
            renderTable();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('select-all-expedicao');
            const confirmableItems = filteredData.filter(item => 
                item.currentStage === 'expedicao' && 
                item.statusExpedicao === 'aguardandoConfirmacao' &&
                item.separado === item.qtdOriginal
            );
            
            const allSelected = confirmableItems.length > 0 && confirmableItems.every(item => item.selected);
            const anySelected = confirmableItems.some(item => item.selected);

            if (confirmableItems.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.disabled = true;
            } else {
                selectAllCheckbox.disabled = false;
                if (allSelected) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (anySelected) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
            }
            console.log('updateSelectAllCheckbox: Todos selecionados:', allSelected, 'Alguns selecionados:', anySelected, 'Total confirm√°veis:', confirmableItems.length);
        }

        async function confirmSelectedItems() {
            const selectedItems = data.filter(item => item.selected && 
                item.currentStage === 'expedicao' && item.statusExpedicao === 'aguardandoConfirmacao');

            if (selectedItems.length === 0) {
                showAlert('Nenhum item selecionado para confirmar ou itens selecionados n√£o est√£o prontos para confirma√ß√£o.', 'info');
                return;
            }

            if (confirm(`Confirmar o recebimento de ${selectedItems.length} item(ns) e mov√™-los para Conclu√≠do?`)) {
                const itemsToUpdate = selectedItems.map(item => ({
                    id: item.id,
                    _rowIndex: item._rowIndex,
                    separado: item.qtdOriginal,
                    currentStage: 'concluido',
                    statusExpedicao: 'confirmado',
                }));

                await updateItemInGoogleSheet(itemsToUpdate);
                document.getElementById('select-all-expedicao').checked = false;
            }
        }
        
        function renderTable() {
            console.log('10. renderTable() - Iniciando renderiza√ß√£o.');
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const checkboxHeader = document.getElementById('checkbox-header');
            if (currentProfile === 'expedicao') {
                checkboxHeader.classList.remove('hidden');
            } else {
                checkboxHeader.classList.add('hidden');
            }
            
            if (filteredData.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="10" style="text-align: center; padding: 20px;">Nenhum item encontrado para este perfil ou filtros.</td>`;
                tbody.appendChild(noDataRow);
                console.log('10.1. renderTable: Nenhum dado filtrado para exibi√ß√£o.');
                return;
            }

            filteredData.forEach((item) => {
                let displayStatusClass = item.status; 
                let displayStatusLabel = getStatusLabel(item.status);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${currentProfile === 'expedicao' ? '' : 'hidden'}">
                        <input type="checkbox" class="expedicao-checkbox" 
                               data-id="${item.id}" 
                               ${item.selected ? 'checked' : ''}
                               ${(item.currentStage !== 'expedicao' || item.statusExpedicao !== 'aguardandoConfirmacao' || item.separado !== item.qtdOriginal) ? 'disabled' : ''}
                               onchange="selectItem(${item.id}, this.checked)">
                    </td>
                    <td>${item.nf}</td>
                    <td>${item.pedido}</td>
                    <td>${formatDate(item.dataEmissao)}</td>
                    <td>${item.modelo}</td>
                    <td>${item.produto}</td>
                    <td>${item.qtdOriginal}</td>
                    <td>${item.separado}</td>
                    <td><span class="status-badge status-${displayStatusClass}">${displayStatusLabel}</span></td>
                    <td>${getActionButtons(item)}</td>
                `;
                tbody.appendChild(row);
            });
            console.log('10.2. renderTable: Tabela renderizada com', filteredData.length, 'itens.');
        }
        
        function getStatusLabel(status) {
            const labels = {
                'embalagem': 'Na Embalagem',
                'expedicao': 'Na Expedi√ß√£o', 
                'parcial': 'Parcial',
                'concluido': 'Conclu√≠do',
                'aguardandoConfirmacao': 'Aguardando Confirma√ß√£o' 
            };
            return labels[status] || status;
        }
        
        function getActionButtons(item) {
            let buttons = '';
            
            if (currentProfile === 'admin') {
                buttons += `<button class="action-btn" onclick="editItem(${item.id})">Editar</button>`;
            } else if (currentProfile === 'embalagem') {
                if (item.currentStage === 'embalagem') {
                    buttons += `<button class="action-btn success" onclick="separarItem(${item.id})">Separar</button>`;
                }
            } else if (currentProfile === 'expedicao') {
                if (item.currentStage === 'expedicao' && item.statusExpedicao === 'aguardandoConfirmacao') {
                    buttons += `<button class="action-btn success" onclick="confirmarRecebimento(${item.id})">Confirmar</button>`;
                }
            }
            
            return buttons;
        }
        
        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                return date.toLocaleDateString('pt-BR');
            }
            
            if (typeof dateValue === 'string') {
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('pt-BR');
                }
            }
            return String(dateValue);
        }
        
        function editItem(id) {
            const item = data.find(item => item.id === id);
            if (!item) {
                console.error('Item n√£o encontrado para edi√ß√£o:', id);
                return;
            }
            currentEditItem = item;
            document.getElementById('edit-separado').value = item.separado;
            document.getElementById('edit-original').value = item.qtdOriginal;
            document.getElementById('edit-modal').style.display = 'block';
            console.log('editItem: Abrindo modal para item ID:', id, '(_rowIndex:', item._rowIndex + ")");
        }

        document.getElementById('edit-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('edit-form: Submit acionado.');

            if (!currentEditItem) {
                showAlert('Erro: Nenhum item selecionado para edi√ß√£o.', 'danger');
                return;
            }

            const newSeparado = parseInt(document.getElementById('edit-separado').value);
            const qtdOriginal = currentEditItem.qtdOriginal;

            if (isNaN(newSeparado) || newSeparado < 0 || newSeparado > qtdOriginal) {
                showAlert(`Quantidade inv√°lida. Deve ser entre 0 e ${qtdOriginal}.`, 'danger');
                return;
            }

            const updatedItem = { ...currentEditItem };
            updatedItem.separado = newSeparado;

            if (updatedItem.separado === qtdOriginal && qtdOriginal > 0) {
                updatedItem.currentStage = 'expedicao';
                updatedItem.statusExpedicao = 'aguardandoConfirmacao';
                showAlert('Item totalmente separado e movido para Expedi√ß√£o (Aguardando Confirma√ß√£o)!', 'success');
            } else if (updatedItem.separado > 0 && updatedItem.separado < qtdOriginal) {
                updatedItem.currentStage = 'embalagem';
                updatedItem.statusExpedicao = 'parcialmenteSeparado';
                showAlert('Item separado parcialmente!', 'info');
            } else {
                updatedItem.currentStage = 'embalagem';
                updatedItem.statusExpedicao = 'pendente';
                showAlert('Item retornado para Embalagem (pendente)!', 'info');
            }
            updatedItem.status = getStatus(updatedItem.qtdOriginal, updatedItem.separado, updatedItem.currentStage, updatedItem.statusExpedicao);

            await updateItemInGoogleSheet(updatedItem);
            closeModal();
            console.log('edit-form: Edi√ß√£o enviada para o servidor. Item atualizado:', updatedItem);
        });

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditItem = null;
            console.log('closeModal: Modal fechado.');
        }
        
        async function separarItem(id) {
            console.log('separarItem() chamado para item ID:', id);
            const item = data.find(item => item.id === id);
            if (!item) {
                console.error('Item n√£o encontrado para separar:', id);
                return;
            }
            
            if (item.separado === item.qtdOriginal) {
                showAlert('Este item j√° est√° totalmente separado.', 'danger');
                return;
            }

            const remaining = item.qtdOriginal - item.separado;
            const qtdSeparadaStr = prompt(`Quantidade a separar (m√°ximo ${remaining} restante):`, remaining);
            if (qtdSeparadaStr === null) {
                console.log('separarItem: Opera√ß√£o cancelada pelo usu√°rio.');
                return;
            }
            
            const newQtd = parseInt(qtdSeparadaStr);
            if (isNaN(newQtd) || newQtd <= 0 || (item.separado + newQtd) > item.qtdOriginal) {
                showAlert(`Quantidade inv√°lida! Deve ser entre 1 e ${remaining}.`, 'danger');
                console.warn('separarItem: Quantidade inv√°lida fornecida:', newQtd);
                return;
            }
            
            const updatedSeparado = item.separado + newQtd;

            const updatedItem = { ...item };
            updatedItem.separado = updatedSeparado;

            if (updatedItem.separado === updatedItem.qtdOriginal) {
                updatedItem.currentStage = 'expedicao'; 
                updatedItem.statusExpedicao = 'aguardandoConfirmacao'; 
                showAlert('Item totalmente separado e movido para Expedi√ß√£o (Aguardando Confirma√ß√£o)!', 'success');
            } else { 
                updatedItem.currentStage = 'embalagem'; 
                updatedItem.statusExpedicao = 'parcialmenteSeparado'; 
                showAlert('Item separado parcialmente!', 'info');
            }
            updatedItem.status = getStatus(updatedItem.qtdOriginal, updatedItem.separado, updatedItem.currentStage, updatedItem.statusExpedicao);

            await updateItemInGoogleSheet(updatedItem);
            console.log('separarItem: Requisi√ß√£o de atualiza√ß√£o enviada para:', updatedItem);
        }
        
        async function confirmarRecebimento(id) {
            console.log('confirmarRecebimento() chamado para item ID:', id);
            const item = data.find(item => item.id === id);
            if (!item) {
                console.error('Item n√£o encontrado para confirmar recebimento:', id);
                return;
            }

            if (item.currentStage !== 'expedicao' || item.statusExpedicao !== 'aguardandoConfirmacao') {
                showAlert('Este item n√£o est√° aguardando confirma√ß√£o na Expedi√ß√£o.', 'danger');
                console.warn('confirmarRecebimento: Item n√£o eleg√≠vel para confirma√ß√£o:', item);
                return;
            }

            if (confirm('Confirmar recebimento e mover este item para Conclu√≠do?')) {
                const updatedItem = { ...item };
                updatedItem.currentStage = 'concluido'; 
                updatedItem.statusExpedicao = 'confirmado'; 
                updatedItem.status = getStatus(updatedItem.qtdOriginal, updatedItem.separado, updatedItem.currentStage, updatedItem.statusExpedicao);

                await updateItemInGoogleSheet(updatedItem);
                console.log('confirmarRecebimento: Requisi√ß√£o de atualiza√ß√£o enviada para:', updatedItem);
            } else {
                console.log('confirmarRecebimento: Opera√ß√£o cancelada pelo usu√°rio.');
            }
        }

        function setupFilters() {
            document.getElementById('filter-nf').addEventListener('input', updateDisplay);
            document.getElementById('filter-pedido').addEventListener('input', updateDisplay);
            document.getElementById('filter-produto').addEventListener('input', updateDisplay);
            document.getElementById('filter-status').addEventListener('change', updateDisplay);
            document.getElementById('filter-expedicao-view').addEventListener('change', updateDisplay);
            console.log('Filtros configurados.');
        }

        let currentAlertTimeout;
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            alertContainer.style.display = 'block';

            if (currentAlertTimeout) {
                clearTimeout(currentAlertTimeout);
            }
            currentAlertTimeout = setTimeout(() => {
                alertContainer.style.display = 'none';
                alertContainer.innerHTML = '';
            }, 5000);
            console.log(`Alerta (${type}): ${message}`);
        }
    </script>
</body>
</html>